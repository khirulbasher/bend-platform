import { Subject } from 'rxjs';
import { httpStatus } from '../http/http-status';
import { BendCoreConstants } from '../../environments/bend-core-constants';
export class ConsoleAuthenticationCallback {
    constructor(consoleService) {
        this.consoleService = consoleService;
    }
    authenticationState(isAuthenticated, message, error) {
        if (error == null) {
            this.consoleService.message(message);
        }
        else {
            this.consoleService.error(message, error);
        }
    }
}
export class AbstractAuthenticationService {
    constructor(accountService, consoleService, storageService) {
        this.accountService = accountService;
        this.consoleService = consoleService;
        this.storageService = storageService;
        this.authenticationState = new Subject();
        this.SUCCESS_MESSAGE = 'Authenticated Successfully';
        this.FAILURE_MESSAGE = 'Error Occurred During Authentication';
    }
    authenticate(info, callback) {
        if (callback == null) {
            callback = new ConsoleAuthenticationCallback(this.consoleService);
        }
        this.accountService.login(info)
            .subscribe((res) => {
            if (res.status === httpStatus.OK) {
                this.accountInfo = res.body;
                if (this.accountInfo != null && this.accountInfo.authenticated) {
                    this.saveToCookie(this.accountInfo);
                    this.authenticationState.next(this.accountInfo);
                    callback.authenticationState(true, this.SUCCESS_MESSAGE);
                }
                else {
                    this.authenticationState.next(null);
                    callback.authenticationState(false, this.FAILURE_MESSAGE);
                }
            }
            else {
                this.authenticationState.next(null);
                callback.authenticationState(false, this.FAILURE_MESSAGE);
            }
        }, (res) => {
            this.deleteCookie();
            this.authenticationState.next(null);
            callback.authenticationState(false, this.FAILURE_MESSAGE);
        });
    }
    saveToCookie(accountInfo) {
        this.saveCookieByKey(BendCoreConstants.cookies.AUTHENTICATION_STATE, JSON.stringify(accountInfo.authenticated));
        this.saveCookieByKey(BendCoreConstants.cookies.TOKEN, accountInfo.token);
        this.saveCookieByKey(BendCoreConstants.cookies.AUTHORITIES, JSON.stringify(accountInfo.authorities));
        accountInfo.token = null;
        accountInfo.authorities = [];
        this.saveCookieByKey(BendCoreConstants.cookies.ACCOUNT_INFO, JSON.stringify(accountInfo));
    }
    refreshToken(token) {
        this.deleteCookieByKey(BendCoreConstants.cookies.TOKEN);
        this.saveCookieByKey(BendCoreConstants.cookies.TOKEN, token);
    }
    retrieveAccountInfo() {
        const cookie = this.retrieveCookieByKey(BendCoreConstants.cookies.ACCOUNT_INFO);
        if (cookie == null || cookie.length < 1) {
            this.accountService.accountInfo().subscribe((resp) => {
                if (resp.status === httpStatus.OK) {
                    const accInfo = resp.body;
                    this.saveToCookie(accInfo);
                    const sub = new Subject();
                    sub.next(accInfo);
                    return sub.asObservable();
                }
                else {
                    this.consoleService.error('No Account Info Found');
                }
            }, (err) => {
                this.consoleService.error('Error Occurred During Account Fetch', err);
            });
        }
        this.accountInfo = JSON.parse(cookie);
        const subject = new Subject();
        subject.next(this.accountInfo);
        return subject.asObservable();
    }
    isAuthenticated() {
        const cookie = this.retrieveCookieByKey(BendCoreConstants.cookies.AUTHENTICATION_STATE);
        if (cookie == null || cookie.length < 1) {
            return false;
        }
        return JSON.parse(cookie);
    }
    currentToken() {
        return this.retrieveCookieByKey(BendCoreConstants.cookies.TOKEN);
    }
    authorities() {
        const authorities = this.retrieveCookieByKey(BendCoreConstants.cookies.AUTHORITIES);
        if (authorities == null || authorities.length < 1) {
            return [];
        }
        return JSON.parse(authorities);
    }
    getAuthenticationState() {
        return this.authenticationState.asObservable();
    }
    deleteCookie() {
        this.deleteCookieByKey(BendCoreConstants.cookies.TOKEN);
        this.deleteCookieByKey(BendCoreConstants.cookies.AUTHORITIES);
        this.deleteCookieByKey(BendCoreConstants.cookies.ACCOUNT_INFO);
        this.deleteCookieByKey(BendCoreConstants.cookies.AUTHENTICATION_STATE);
    }
    logout(info) {
        this.deleteCookie();
        this.authenticationState.next(null);
        this.consoleService.message('Logout Success of User' + info.logoutRule);
    }
    hasAnyAuthority(authorities) {
        const grantedAuthorities = this.authorities();
        for (const auth of authorities) {
            if (grantedAuthorities.includes(auth)) {
                return true;
            }
        }
        return false;
    }
    deleteCookieByKey(key) {
        this.storageService.remove(key);
    }
    saveCookieByKey(key, value) {
        this.storageService.put(key, value);
    }
    retrieveCookieByKey(key) {
        return this.storageService.get(key);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWJzdHJhY3QtYXV0aGVudGljYXRpb24tc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JlbmQtY29yZS8iLCJzb3VyY2VzIjpbImxpYi9zZWN1cml0eS9hdXRoL2Fic3RyYWN0LWF1dGhlbnRpY2F0aW9uLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUt6QyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFDL0MsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sd0NBQXdDLENBQUM7QUFPekUsTUFBTSxPQUFPLDZCQUE2QjtJQUN4QyxZQUNVLGNBQThCO1FBQTlCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtJQUV4QyxDQUFDO0lBQ0QsbUJBQW1CLENBQUMsZUFBd0IsRUFBRSxPQUFnQixFQUFFLEtBQXlCO1FBQ3ZGLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtZQUNqQixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN0QzthQUFNO1lBQ0wsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNDO0lBQ0gsQ0FBQztDQUNGO0FBc0JELE1BQU0sT0FBZ0IsNkJBQTZCO0lBTWpELFlBQ1UsY0FBa0MsRUFDbEMsY0FBOEIsRUFDOUIsY0FBOEI7UUFGOUIsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQ2xDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFQOUIsd0JBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQWUsQ0FBQztRQUMzRCxvQkFBZSxHQUFHLDRCQUE0QixDQUFDO1FBQy9DLG9CQUFlLEdBQUcsc0NBQXNDLENBQUM7SUFNdEQsQ0FBQztJQUVKLFlBQVksQ0FBQyxJQUFlLEVBQUUsUUFBaUM7UUFDN0QsSUFB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LENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFRCxlQUFlLENBQUMsV0FBcUI7UUFDbkMsTUFBTSxrQkFBa0IsR0FBYSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDeEQsS0FBSyxNQUFNLElBQUksSUFBSSxXQUFXLEVBQUU7WUFDOUIsSUFBSSxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQUUsT0FBTyxJQUFJLENBQUM7YUFBRTtTQUN4RDtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVTLGlCQUFpQixDQUFDLEdBQVc7UUFDckMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVTLGVBQWUsQ0FBQyxHQUFXLEVBQUUsS0FBYTtRQUNsRCxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVTLG1CQUFtQixDQUFDLEdBQVc7UUFDdkMsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge0JlbmRBY2NvdW50U2VydmljZX0gZnJvbSAnLi9iZW5kLWFjY291bnQuc2VydmljZSc7XHJcbmltcG9ydCB7SHR0cEVycm9yUmVzcG9uc2UsIEh0dHBSZXNwb25zZX0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQge0NvbnNvbGVTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlL2NvbnNvbGUvY29uc29sZS5zZXJ2aWNlJztcclxuaW1wb3J0IHtBY2NvdW50SW5mbywgTG9naW5JbmZvLCBMb2dvdXRJbmZvfSBmcm9tICcuLi8uLi9tb2RlbC9hY2NvdW50Lm1vZGVsJztcclxuaW1wb3J0IHtodHRwU3RhdHVzfSBmcm9tICcuLi9odHRwL2h0dHAtc3RhdHVzJztcclxuaW1wb3J0IHtCZW5kQ29yZUNvbnN0YW50c30gZnJvbSAnLi4vLi4vZW52aXJvbm1lbnRzL2JlbmQtY29yZS1jb25zdGFudHMnO1xyXG5pbXBvcnQge1N0b3JhZ2VTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlL3N0b3JhZ2Uvc3RvcmFnZS1zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSUF1dGhlbnRpY2F0aW9uQ2FsbGJhY2sge1xyXG4gIGF1dGhlbnRpY2F0aW9uU3RhdGUoaXNBdXRoZW50aWNhdGVkOiBib29sZWFuLCBtZXNzYWdlPzogc3RyaW5nLCBlcnJvcj86IEh0dHBFcnJvclJlc3BvbnNlKTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIENvbnNvbGVBdXRoZW50aWNhdGlvbkNhbGxiYWNrIGltcGxlbWVudHMgSUF1dGhlbnRpY2F0aW9uQ2FsbGJhY2sge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjb25zb2xlU2VydmljZTogQ29uc29sZVNlcnZpY2VcclxuICApIHtcclxuICB9XHJcbiAgYXV0aGVudGljYXRpb25TdGF0ZShpc0F1dGhlbnRpY2F0ZWQ6IGJvb2xlYW4sIG1lc3NhZ2U/OiBzdHJpbmcsIGVycm9yPzogSHR0cEVycm9yUmVzcG9uc2UpOiB2b2lkIHtcclxuICAgIGlmIChlcnJvciA9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMuY29uc29sZVNlcnZpY2UubWVzc2FnZShtZXNzYWdlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuY29uc29sZVNlcnZpY2UuZXJyb3IobWVzc2FnZSwgZXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJQWJzdHJhY3RBdXRoZW50aWNhdGlvblNlcnZpY2Uge1xyXG4gIGF1dGhlbnRpY2F0ZShpbmZvOiBMb2dpbkluZm8sIGNhbGxiYWNrPzogSUF1dGhlbnRpY2F0aW9uQ2FsbGJhY2spO1xyXG5cclxuICByZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZyk7XHJcblxyXG4gIHJldHJpZXZlQWNjb3VudEluZm8oKTogT2JzZXJ2YWJsZTxBY2NvdW50SW5mbz47XHJcblxyXG4gIGlzQXV0aGVudGljYXRlZCgpOiBib29sZWFuO1xyXG5cclxuICBjdXJyZW50VG9rZW4oKTogc3RyaW5nO1xyXG5cclxuICBhdXRob3JpdGllcygpOiBzdHJpbmdbXTtcclxuXHJcbiAgZ2V0QXV0aGVudGljYXRpb25TdGF0ZSgpOiBPYnNlcnZhYmxlPEFjY291bnRJbmZvPjtcclxuXHJcbiAgbG9nb3V0KGluZm86IExvZ291dEluZm8pO1xyXG5cclxuICBoYXNBbnlBdXRob3JpdHkoYXV0aG9yaXRpZXM6IHN0cmluZ1tdKTogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFic3RyYWN0QXV0aGVudGljYXRpb25TZXJ2aWNlIGltcGxlbWVudHMgSUFic3RyYWN0QXV0aGVudGljYXRpb25TZXJ2aWNlIHtcclxuICBwcm90ZWN0ZWQgYWNjb3VudEluZm86IEFjY291bnRJbmZvO1xyXG4gIHByb3RlY3RlZCBhdXRoZW50aWNhdGlvblN0YXRlID0gbmV3IFN1YmplY3Q8QWNjb3VudEluZm8+KCk7XHJcbiAgU1VDQ0VTU19NRVNTQUdFID0gJ0F1dGhlbnRpY2F0ZWQgU3VjY2Vzc2Z1bGx5JztcclxuICBGQUlMVVJFX01FU1NBR0UgPSAnRXJyb3IgT2NjdXJyZWQgRHVyaW5nIEF1dGhlbnRpY2F0aW9uJztcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGFjY291bnRTZXJ2aWNlOiBCZW5kQWNjb3VudFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGNvbnNvbGVTZXJ2aWNlOiBDb25zb2xlU2VydmljZSxcclxuICAgIHByaXZhdGUgc3RvcmFnZVNlcnZpY2U6IFN0b3JhZ2VTZXJ2aWNlXHJcbiAgKSB7fVxyXG5cclxuICBhdXRoZW50aWNhdGUoaW5mbzogTG9naW5JbmZvLCBjYWxsYmFjazogSUF1dGhlbnRpY2F0aW9uQ2FsbGJhY2spIHtcclxuICAgIGlmIChjYWxsYmFjayA9PSBudWxsKSB7XHJcbiAgICAgIGNhbGxiYWNrID0gbmV3IENvbnNvbGVBdXRoZW50aWNhdGlvbkNhbGxiYWNrKHRoaXMuY29uc29sZVNlcnZpY2UpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5hY2NvdW50U2VydmljZS5sb2dpbihpbmZvKVxyXG4gICAgICAuc3Vic2NyaWJlKChyZXM6IEh0dHBSZXNwb25zZTxBY2NvdW50SW5mbz4pID0+IHtcclxuICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gaHR0cFN0YXR1cy5PSykge1xyXG4gICAgICAgICAgdGhpcy5hY2NvdW50SW5mbyA9IHJlcy5ib2R5O1xyXG4gICAgICAgICAgaWYgKHRoaXMuYWNjb3VudEluZm8gIT0gbnVsbCAmJiB0aGlzLmFjY291bnRJbmZvLmF1dGhlbnRpY2F0ZWQgKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZVRvQ29va2llKHRoaXMuYWNjb3VudEluZm8pO1xyXG4gICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU3RhdGUubmV4dCh0aGlzLmFjY291bnRJbmZvKTtcclxuICAgICAgICAgICAgY2FsbGJhY2suYXV0aGVudGljYXRpb25TdGF0ZSh0cnVlLCB0aGlzLlNVQ0NFU1NfTUVTU0FHRSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU3RhdGUubmV4dChudWxsKTtcclxuICAgICAgICAgICAgY2FsbGJhY2suYXV0aGVudGljYXRpb25TdGF0ZShmYWxzZSwgdGhpcy5GQUlMVVJFX01FU1NBR0UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU3RhdGUubmV4dChudWxsKTtcclxuICAgICAgICAgIGNhbGxiYWNrLmF1dGhlbnRpY2F0aW9uU3RhdGUoZmFsc2UsIHRoaXMuRkFJTFVSRV9NRVNTQUdFKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgfSAsIChyZXM6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmRlbGV0ZUNvb2tpZSgpO1xyXG4gICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblN0YXRlLm5leHQobnVsbCk7XHJcbiAgICAgICAgICBjYWxsYmFjay5hdXRoZW50aWNhdGlvblN0YXRlKGZhbHNlLCB0aGlzLkZBSUxVUkVfTUVTU0FHRSk7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHNhdmVUb0Nvb2tpZShhY2NvdW50SW5mbzogQWNjb3VudEluZm8pIHtcclxuICAgIHRoaXMuc2F2ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuQVVUSEVOVElDQVRJT05fU1RBVEUsIEpTT04uc3RyaW5naWZ5KGFjY291bnRJbmZvLmF1dGhlbnRpY2F0ZWQpKTtcclxuICAgIHRoaXMuc2F2ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuVE9LRU4sIGFjY291bnRJbmZvLnRva2VuKTtcclxuICAgIHRoaXMuc2F2ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuQVVUSE9SSVRJRVMsIEpTT04uc3RyaW5naWZ5KGFjY291bnRJbmZvLmF1dGhvcml0aWVzKSk7XHJcbiAgICBhY2NvdW50SW5mby50b2tlbiA9IG51bGw7XHJcbiAgICBhY2NvdW50SW5mby5hdXRob3JpdGllcyA9IFtdO1xyXG4gICAgdGhpcy5zYXZlQ29va2llQnlLZXkoQmVuZENvcmVDb25zdGFudHMuY29va2llcy5BQ0NPVU5UX0lORk8sIEpTT04uc3RyaW5naWZ5KGFjY291bnRJbmZvKSk7XHJcbiAgfVxyXG5cclxuICByZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZykge1xyXG4gICAgdGhpcy5kZWxldGVDb29raWVCeUtleShCZW5kQ29yZUNvbnN0YW50cy5jb29raWVzLlRPS0VOKTtcclxuICAgIHRoaXMuc2F2ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuVE9LRU4sIHRva2VuKTtcclxuICB9XHJcblxyXG4gIHJldHJpZXZlQWNjb3VudEluZm8oKTogT2JzZXJ2YWJsZTxBY2NvdW50SW5mbz4ge1xyXG4gICAgY29uc3QgY29va2llID0gdGhpcy5yZXRyaWV2ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuQUNDT1VOVF9JTkZPKTtcclxuICAgIGlmIChjb29raWUgPT0gbnVsbCB8fCBjb29raWUubGVuZ3RoIDwgMSkge1xyXG4gICAgICB0aGlzLmFjY291bnRTZXJ2aWNlLmFjY291bnRJbmZvKCkuc3Vic2NyaWJlKChyZXNwOiBIdHRwUmVzcG9uc2U8QWNjb3VudEluZm8+KSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzID09PSBodHRwU3RhdHVzLk9LKSB7XHJcbiAgICAgICAgICBjb25zdCBhY2NJbmZvID0gcmVzcC5ib2R5O1xyXG4gICAgICAgICAgdGhpcy5zYXZlVG9Db29raWUoYWNjSW5mbyk7XHJcbiAgICAgICAgICBjb25zdCBzdWIgPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgICAgICAgc3ViLm5leHQoYWNjSW5mbyk7XHJcbiAgICAgICAgICByZXR1cm4gc3ViLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmNvbnNvbGVTZXJ2aWNlLmVycm9yKCdObyBBY2NvdW50IEluZm8gRm91bmQnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIChlcnI6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgdGhpcy5jb25zb2xlU2VydmljZS5lcnJvcignRXJyb3IgT2NjdXJyZWQgRHVyaW5nIEFjY291bnQgRmV0Y2gnLCBlcnIpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHRoaXMuYWNjb3VudEluZm8gPSBKU09OLnBhcnNlKGNvb2tpZSApO1xyXG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBzdWJqZWN0Lm5leHQodGhpcy5hY2NvdW50SW5mbyk7XHJcbiAgICByZXR1cm4gc3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIGlzQXV0aGVudGljYXRlZCgpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGNvb2tpZSA9IHRoaXMucmV0cmlldmVDb29raWVCeUtleShCZW5kQ29yZUNvbnN0YW50cy5jb29raWVzLkFVVEhFTlRJQ0FUSU9OX1NUQVRFKTtcclxuICAgIGlmIChjb29raWUgPT0gbnVsbCB8fCBjb29raWUubGVuZ3RoIDwgMSApIHsgcmV0dXJuIGZhbHNlOyB9XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShjb29raWUpO1xyXG4gIH1cclxuXHJcbiAgY3VycmVudFRva2VuKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXRyaWV2ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuVE9LRU4pO1xyXG4gIH1cclxuXHJcbiAgYXV0aG9yaXRpZXMoKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgYXV0aG9yaXRpZXMgPSB0aGlzLnJldHJpZXZlQ29va2llQnlLZXkoQmVuZENvcmVDb25zdGFudHMuY29va2llcy5BVVRIT1JJVElFUyk7XHJcbiAgICBpZiAoYXV0aG9yaXRpZXMgPT0gbnVsbCB8fCBhdXRob3JpdGllcy5sZW5ndGggPCAxKSB7IHJldHVybiBbXTsgfVxyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoYXV0aG9yaXRpZXMpO1xyXG4gIH1cclxuXHJcbiAgZ2V0QXV0aGVudGljYXRpb25TdGF0ZSgpOiBPYnNlcnZhYmxlPEFjY291bnRJbmZvPiB7XHJcbiAgICByZXR1cm4gdGhpcy5hdXRoZW50aWNhdGlvblN0YXRlLmFzT2JzZXJ2YWJsZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGRlbGV0ZUNvb2tpZSgpIHtcclxuICAgIHRoaXMuZGVsZXRlQ29va2llQnlLZXkoQmVuZENvcmVDb25zdGFudHMuY29va2llcy5UT0tFTik7XHJcbiAgICB0aGlzLmRlbGV0ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuQVVUSE9SSVRJRVMpO1xyXG4gICAgdGhpcy5kZWxldGVDb29raWVCeUtleShCZW5kQ29yZUNvbnN0YW50cy5jb29raWVzLkFDQ09VTlRfSU5GTyk7XHJcbiAgICB0aGlzLmRlbGV0ZUNvb2tpZUJ5S2V5KEJlbmRDb3JlQ29uc3RhbnRzLmNvb2tpZXMuQVVUSEVOVElDQVRJT05fU1RBVEUpO1xyXG4gIH1cclxuXHJcbiAgbG9nb3V0KGluZm86IExvZ291dEluZm8pIHtcclxuICAgIHRoaXMuZGVsZXRlQ29va2llKCk7XHJcbiAgICB0aGlzLmF1dGhlbnRpY2F0aW9uU3RhdGUubmV4dChudWxsKTtcclxuICAgIHRoaXMuY29uc29sZVNlcnZpY2UubWVzc2FnZSgnTG9nb3V0IFN1Y2Nlc3Mgb2YgVXNlcicgKyBpbmZvLmxvZ291dFJ1bGUpO1xyXG4gIH1cclxuXHJcbiAgaGFzQW55QXV0aG9yaXR5KGF1dGhvcml0aWVzOiBzdHJpbmdbXSk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgZ3JhbnRlZEF1dGhvcml0aWVzOiBzdHJpbmdbXSA9IHRoaXMuYXV0aG9yaXRpZXMoKTtcclxuICAgIGZvciAoY29uc3QgYXV0aCBvZiBhdXRob3JpdGllcykge1xyXG4gICAgICBpZiAoZ3JhbnRlZEF1dGhvcml0aWVzLmluY2x1ZGVzKGF1dGgpKSB7IHJldHVybiB0cnVlOyB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZGVsZXRlQ29va2llQnlLZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgIHRoaXMuc3RvcmFnZVNlcnZpY2UucmVtb3ZlKGtleSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc2F2ZUNvb2tpZUJ5S2V5KGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnN0b3JhZ2VTZXJ2aWNlLnB1dChrZXksIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCByZXRyaWV2ZUNvb2tpZUJ5S2V5KGtleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldChrZXkpO1xyXG4gIH1cclxufVxyXG4iXX0=